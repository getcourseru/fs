const PARAMS = parseURL()

function parseURL() {
    const params = {}
    const url = new URL(document.location.href)
    const { pathname, searchParams } = url

    params.pathname = pathname.split('/')
    
    /*if (pathname.split(`/`).includes('editor')) {
    	const $page = document.querySelector('.lite-page')
        $page.innerHTML = ''
        return
    }*/
    
    for (let [name, value] of searchParams) {
        params[`${name}`] = value
    }

    const i = params.pathname.indexOf('order')
    params.folder = params.pathname[i + 1]
	
    params.referrer = document.referrer 
        ? document.referrer 
        : false
    
    //?lessonDuration=60&lessonCount=5

    return params
}

const { lessonDuration, lessonCount, folder } = PARAMS
console.log(PARAMS)

if (lessonDuration && lessonCount && folder) {
    fetch(`https://getcourseru.github.io/fs/${folder}/data.json`)
        .then(response => response.json())
        .then(data => getOffer(data))
} else {
    showNotification()
}

function getOffer(data) {
    console.log(data)
    const [product,] = data.filter(item => item.lessonDuration === lessonDuration && item.lessonCount === lessonCount)
    console.log(product)
    
    if (product) {
        const { offer } = product

        if (document.querySelector(`.form-position-offer-${offer}`)) {
            const $offer = document.querySelector(`.form-position-offer-${offer}`)
            $offer.checked = true
            renderForm(product)
        } else {
            console.log(`check offer IDs`)
        }
	    
	    return
    }
	
    showNotification()
}

function renderForm(product) {
    const { price } = product
    const $container = document.querySelector('.form-content .builder');
    const $btn = $container.querySelector('.f-btn');

	$container.insertAdjacentHTML('afterbegin', 
        `<div class='prod'>
            <p class='prod__title'>{ КодКодыч<span>${lessonDuration} минут</span>${lessonCount} уроков }</p>
        </div>`);

    $btn.innerText = 'Оплатить';
    $btn.parentElement.insertAdjacentHTML('beforebegin', 
        `<div class='price'>
            <div class='price__text'>К оплате:<span id='price'>${price}</span>₽</div>
        </div>`
    );
	
    addPlaceholder()
}

function showNotification() {
    if (!document.querySelector('form')) {
    	return
    }
	
    const $form = document.querySelector('form')
    $form.style.display = 'none'

    const $parentForm = $form.parentNode.parentNode
    $parentForm.insertAdjacentHTML('afterbegin', 
        `<div class='nt'>
            <div class='nt__container'>
                <div class='nt__image'>
                    <img src='https://fs.getcourse.ru/fileservice/file/download/a/13641/sc/341/h/43d1d1bdc86e74ead187f37ae1adf836.png'>
                </div>
                <div class='nt__content'>
                    <p>Так-с, кажется, что-то пошло не так...</p>
                    <p>Вернись на шаг назад и попробуй выбрать предложение</p>
                    <a href='${PARAMS.referrer ? PARAMS.referrer : `https://kodkodych.ru/payment.html`}'>Вернуться</a>
                </div>
            </div>
        </div>`);
}

function addPlaceholder() {
    const [$name,] = document.getElementsByName('formParams[full_name]');
    $name.placeholder = `Имя`;
    $name.required = true
    
    const [$email,] = document.getElementsByName('formParams[email]');
    $email.placeholder = `Email`;
    $email.required = true

    const [$phone,] = document.getElementsByName('formParams[phone]');
    $phone.placeholder = `Телефон`;
    $phone.required = true
}
